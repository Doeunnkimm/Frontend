## 24.6 자주 발생하는 실수

아래는 클로저를 사용할 때 자주 발생할 수 있는 실수를 보여주는 예제다.

```js
var func = []

for (var i=0; i<3; i++) {
    func[i] = function () { return i } // 1
}

for (var j=0; j<func.length; j++) {
    console.log(func[j]()) // 2
}
```

- 첫 번째 for 문의 코드 블록 내에서 함수가 func 배열의 요소로 추가된다.
- 그리고 두 번째 for 문의 코드 블록 내에서 func 배열의 요소로 추가된 함수를 순차적으로 호출한다.
- 이때 func 배열의 요소로 추가된 3개의 함수가 0, 1, 2를 반환할 것으로 기대했다면 아쉽지만 결과가 그렇지 X

클로저를 사용해 위 예제를 바르게 동작하는 코드를 만들어보자

```js
var func = []

for (var i=0; i<3; i++) {
    func[i] = (function (id) { // 1
        return function () {
            return id;
        }
    }(i))
}

for (var j=0; j<func.length; j++) {
    console.log(func[j]())
}
```

- 1에서 즉시 실행 함수는 전역 변수 i에 현재 할당되어 있는 값을 인수로 전달받아 매개변수 id에 할당한 후 중첩 함수를 반환하고 종료된다.
- 즉시 실행 함수가 반환한 함수가 func 배열에 순차적으로 저장된다.
- 이때 즉시 실행 함수의 매개변수 id는 즉시 실행 함수가 반환한 중첩 함수의 상위 스코프에 존재한다.
- 즉시 실행 함수가 반환한 중첩 함수는 자신의 상위 스코프를 기억하는 클로저이고, 매개변수 id는 즉시 실행 함수가 반환한 중첩 함수에 묶여있는 자유 변수가 되어 그 값이 유지된다.